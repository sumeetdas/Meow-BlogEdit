angular.module("meow.blog.edit",["ngRoute","blogEditTemplates","ngSanitize","hc.marked","ngMorph"]).config(["$routeProvider",function(e){var t=["$http","$rootScope",function(e,t){return t.meta||t.meta instanceof Object?t.meta:e({method:"GET",url:"/api/meta"}).then(function(e){return e=e.data||{},t.meta={blogsPerPage:e.blogsPerPage||5,username:e.username||"John Doe",tags:e.tags||[],disqus:e.disqus||{},angularSocialShare:e.angularSocialShare||{}},t.meta})}];e.when("/blogs",{controller:"BlogEditCtrl",templateUrl:"blog-edit.list.tpl.html",resolve:{meta:t}}).when("/blogs/tag/:tag",{controller:"BlogEditCtrl",templateUrl:"blog-edit.list.tpl.html",resolve:{meta:t}}).when("/blogs/query/:query",{controller:"BlogEditCtrl",templateUrl:"blog-edit.list.tpl.html",resolve:{meta:t}})}]).run(["$http","$rootScope","$routeParams","$blogEdit",function(e,t,o,r){function l(e){t.$on("$routeChangeSuccess",function(){o.tag?r.getBlogsByTag(o.tag,function(e){t.blogs=e},e):o.query?r.getBlogsByQuery(o.query,function(e){t.blogs=e},e):r.getBlogs(function(e){t.blogs=e},e)})}t.meta&&t.meta instanceof Object?l(t.meta.blogsPerPage):e.get("/api/meta").then(function(e){return e=e.data||{},e.blogsPerPage}).then(function(e){l(e)})}]),angular.module("meow.blog.edit").service("$blogEdit",["$http",function(e){function t(e){if(e)if("string"==typeof e)try{e=parseInt(e)}catch(t){e=1}else"number"!=typeof e&&(e=1);else e=1;var o=b.length;return o?parseInt(o/e)+(o%e===0?0:1):1}function o(o,r,l){e.get("/api/blogs/tags/"+o).success(function(e){b=e,p=t(l),f=1,"function"==typeof r&&r(b.slice(0,l))}).error(console.error)}function r(o,r,l){e.get("/api/blogs/query/"+o).success(function(e){b=e,p=t(l),f=1,"function"==typeof r&&r(b.slice(0,l))}).error(console.error)}function l(o,r){e.get("/api/blogs").success(function(e){b=e,p=t(r),f=1,"function"==typeof o&&o(b.slice(0,r))}).error(console.error)}function n(t,o){e.get("/api/blogs/posts/"+t.year+"/"+t.month+"/"+t.date+"/"+t.slug).success(function(e){o(e)}).error(console.error)}function s(e,t){f>1&&(f-=1,e(b.slice((f-1)*t,f*t)))}function i(e,t){p>f&&(f+=1,e(b.slice((f-1)*t,f*t)))}function a(e){if("string"!=typeof e)throw new Error("pFileName is not a string");var t=e.split("-"),o=t.shift(),r=t.shift(),l=t.shift(),n=t.join("-");return{year:o,month:r,date:l,slug:n,formattedDate:v[r-1]+" "+parseInt(l)+", "+o}}function g(t){0===m.length?e.get("/tags").success(function(e){(!e||!e instanceof Array)&&(e=["meow","bow"]),m=e,t(e)}).error(console.error):t(m)}function u(t,o){var r=!(t.slug&&t.year&&t.month&&t.date);r?e.post("/api/blogs",t).success(function(e){o("success",e)}).error(function(e){o("error",e)}):e.put("/api/blogs/posts/"+t.year+"/"+t.month+"/"+t.date+"/"+t.slug,t).success(function(e){o("success",e)}).error(function(e){o("error",e)})}function c(t,o){e["delete"]("/api/blogs/posts/"+t.year+"/"+t.month+"/"+t.date+"/"+t.slug).success(function(e){o("success",e)}).error(function(e){o("error",e)})}function d(e,t){e=e||{post:""},e.post=e.post||"";var o={},r=e.post.split("\n"),l=r.length,n=1,s=[];if("<!--"!==r[0].trim())throw new Error('Incorrect format, missing "<!--"');for(;l>n;){var i=r[n].trim();if("-->"===i)break;""!==i?(s.push(i),n+=1):n+=1}if(n===l)throw new Error('Incorrect format, missing "-->"');s=jsyaml.load(s.join("\n"))||{};var a=s["published-date"];a=v[a.getMonth()]+" "+a.getDate()+", "+a.getFullYear(),o.title=s.title,o.subtitle=s.subtitle,o["published-date"]=a,o.post=e.post,o.tags=[],s.tags=s.tags||"";var g=s.tags.split(",");for(var u in g)o.tags.push(g[u].trim());t(o)}var f=1,p=1,b=[],m=[],v=["January","February","March","April","May","June","July","August","September","October","November","December"];return{getCurrentPageNo:function(){return f},getPageCount:function(){return p},getBlogsByTag:o,getBlogsByQuery:r,getBlogs:l,getBlog:n,getPrevBlogs:s,getNextBlogs:i,parseFileName:a,getTags:g,saveBlog:u,deleteBlog:c,previewBlog:d}}]),angular.module("meow.blog.edit").directive("post",["$compile","marked",function(e,t){return{restrict:"A",replace:!0,link:function(o,r,l){o.$watch(l.post,function(l){l&&"string"==typeof l&&0!==l.length&&(r.html(t(l)),e(r.contents())(o))})}}}]).directive("youtube",["$sce",function(e){return{restrict:"E",replace:!0,template:'<div class="embed-responsive embed-responsive-16by9"><iframe class="embed-responsive-item" allowfullscreen src="{{url}}"/></div>',link:function(t,o,r){t.url=e.trustAsResourceUrl(r.url)}}}]),angular.module("meow.blog.edit").controller("BlogEditCtrl",["$scope","$blogEdit","$location","meta","$timeout","$route",function(e,t,o,r,l,n){e.blogToEdit={},e.blogToDelete={},e.previewBlog={},e.verify={deleteInput:"",deleteDone:!1,blogSaved:!1,incorrectDeleteInput:!1},e.error={blogSaved:!1,blogDeleted:!1},e.message={blogSaved:"The blog has been saved.",blogDeleted:"The blog has been deleted."},e.username=r.username,e.next=function(){t.getNextBlogs(function(t){e.blogs=t},r.blogsPerPage)},e.prev=function(){t.getPrevBlogs(function(t){e.blogs=t},r.blogsPerPage)},e.isFirstPage=function(){return 1===t.getCurrentPageNo()},e.isLastPage=function(){return t.getCurrentPageNo()===t.getPageCount()},e.getFormattedDate=function(e){return t.parseFileName(e.fileName).formattedDate},e.loadBlog=function(o){var r=t.parseFileName(o.fileName);t.getBlog({year:r.year,month:r.month,date:r.date,slug:r.slug},function(t){e.blogToEdit=t,e.getPreviewBlog(t)})},e.deleteBlog=function(o){return e.verify.deleteInput!==o.title?(e.verify.deleteDone=!1,void(e.verify.incorrectDeleteInput=!0)):(o=t.parseFileName(o.fileName),void t.deleteBlog(o,function(t,o){"success"===t?e.verify.deleteDone=!0:"error"===t&&(e.verify.deleteDone=!1,e.error.deleteDone=!0,e.message.blogDeleted="Error "+(o?o:""))}))},e.saveBlog=function(o){console.log(o);var r=t.parseFileName(o.fileName);t.saveBlog({post:o.post,year:r.year,month:r.month,date:r.date,slug:o.slug},function(t,o){"success"==t?e.verify.blogSaved=!0:"error"==t&&(e.verify.blogSaved=!1,e.error.blogSaved=!0,e.message.blogSaved="Error "+(o?o:""))})},e.getPreviewBlog=function(o){e.verify.blogSaved=!1,o.title=o.title||"",o.slug=o.slug||o.title.toLocaleLowerCase().replace(/[\W]/g,"-").replace(/[\-]{2,}/g,"-"),o.fileName=o.fileName||"",t.previewBlog(o,function(t){e.previewBlog=t})},e.blogEditSettings={closeEl:".close",overlay:{templateUrl:"blog-edit.post.tpl.html"}},e.deleteBlogSettings={closeEl:".close",modal:{templateUrl:"blog-edit.delete.tpl.html"}},e.search=function(){o.url("/blogs/query/"+e.query)},e.purgeEditScopeVar=function(){e.verify.blogSaved&&n.reload(),l(function(){e.blogToEdit={},e.previewBlog={},e.verify.blogSaved=!1,e.error.blogSaved=!1,e.message.blogSaved="The blog has been saved"},1e3)},e.purgeDeleteScopeVar=function(){e.verify.deleteDone&&n.reload(),l(function(){e.blogToDelete={},e.verify.deleteDone=!1,e.error.deleteDone=!1,e.verify.deleteInput="",e.verify.incorrectDeleteInput=!1,e.message.blogDeleted="The blog has been deleted"},1e3)},e.loadBlogToDelete=function(t){e.blogToDelete=t},e.addBlog=function(){e.blogToEdit={};var t=new Date;e.blogToEdit.date=t.getDate(),e.blogToEdit.month=t.getMonth(),e.blogToEdit.year=t.getYear(),e.blogToEdit.slug="new-post";var o=[t.getFullYear(),t.getMonth(),t.getDate()].join("-"),r=["<!--","published-date: "+o,"title: New Post","subtitle: ","tags: ","keywords: ","-->","Write your post here..."];e.blogToEdit.post=r.join("\n"),e.getPreviewBlog(e.blogToEdit)}}]);